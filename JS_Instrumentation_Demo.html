<!DOCTYPE html>  
<html> 
<head>
<meta name="description" content="NEMA">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.1.0.js">
    </script>
    <script src="https://www.emogic.com/jqueryrotate/jQueryRotate.js">
    </script>  
    <script>
 var readRate = 100;
var httpAddress = 'http://127.0.0.1:8080'; 
    </script>
  <title>BridgeCommand JS Instrumentation</title>
</head>
<body>

<style>
.container 
  {
  position: relative;
  }
.over 
  {
  position: absolute;
  top: 0px;
  left: 0px;
  }    
 </style>
 
   <table>
    <tr>
      <td>
      HTTP: <input type="checkbox" id="checkBoxHTTP" onchange="checkHTTP()" style='position: relative;z-index: 999;'>  
        </td>
       <td>
       or  
        </td>
       <td>
       <div id="uploadFile_div" style='position: relative;z-index: 999;'>
   <input id='fileinput' type="file" onchange='if (interval > 0) {clearInterval(interval)}; interval = setInterval( fileSelected , readRate );' />
   </div>
        </td>
      </tr>  
  </table>
  
  <table width='100%'>     
  <tr>
    <td width='33%'>
      <div class='container'>
      <img src="https://www.emogic.com/bc/rpm2.png" width='95%'>
      <img class="over" id='portRPM' src="https://www.emogic.com/bc/needle.png" width='95%'>
      </div>
    </td>
    <td width='33%'>
      <img id='compass' src="https://www.emogic.com/bc/compass.png" width='95%'>
    </td>
    <td width='33%'>
      <div class='container'>
      <img src="https://www.emogic.com/bc/rpm2.png" width='95%'><img class="over" id='starboardRPM' src="https://www.emogic.com/bc/needle.png" width='95%'> 
      </div>
    </td>
    </tr>  
    
  </table>
  
  <table width='100%'>
    
  <tr>
   <td width='33%'>&nbsp;</td>
   <td width='33%' align='center'>
    <div id='compassDigital' style='font-family: "IBM Plex Sans", sans-serif;'>0.0</div>
    </td>
   <td width='33%'>&nbsp;</td>
 </tr>
    
  <tr>
   <td width='33%'></td>
   <td width='33%' class='container'>
     <img src="https://www.emogic.com/bc/rudder.png" width='95%'>
     <img id='rudder' src="https://www.emogic.com/bc/rudderneedle.png" width='95%' class="over">
    </td>
   <td width='33%'></td>
 </tr>
    
  </table>
  
<div id='nEMAText'></div>

<script>
var interval;

function getHTML() 
    { 
    $.get( httpAddress , processHTML )
      .fail(function() { $( "#nEMAText" ).html( 'ajax error' ); }); 
    } 
  
function processHTML(data)
    {
    $( "#nEMAText" ).html('');
 
    var DataArray = data.split("\n"); //turn lines into array 
    var LineArray;
          
    var RMC = {};
    var RSA = {}; 
    var RPM = {}; 
      
    //convert wanted lines to objects
    for (var i = 0, len = DataArray.length; i < len; i++) 
        {
        $( "#nEMAText" ).append( DataArray[i]  + '</br>');
        LineArray = DataArray[i].split(","); //turn DataArray[i] (a string) into an array       
    //compass
    if ( LineArray[0] == '$GPRMC' )
          {
          RMC['UTC'] = LineArray[1];   
          RMC['Status'] = LineArray[2];
          RMC['Track'] = LineArray[8];
          var ang = -1 * RMC['Track'];  
          $("#compass").rotate({ angle:ang  });
          $( "#compassDigital" ).html( String( Math.abs(ang.toFixed(2))) );
          }

    //rudder
    if ( LineArray[0] == '$IIRSA' )  
          {
          RSA['Starboard'] = LineArray[1];  
          var ang = - 2 * RSA['Starboard'];  
          $("#rudder").rotate({ angle: ang }); 
          } 

    //rpm port and starboard    
    if ( LineArray[0] == '$IIRPM' ) 
          {
          RPM['Number'] = LineArray[2]; 
          RPM['RMP'] = Math.abs( LineArray[3] ); //no neg RPM
          if ( RPM['Number'] == 1 ) 
            {
            var ang = .9 * RPM['RMP'];  
            $("#portRPM").rotate({ angle: ang }); 
            }
          if ( RPM['Number'] == 2 ) 
            {
            var ang = .9 * RPM['RMP'];  
            $("#starboardRPM").rotate({ angle: ang }); 
            }
          }           
        }       
    }
  
function fileSelected() 
  {
  document.getElementById("checkBoxHTTP").checked = false;
  var reader;
  nEMAFile = document.getElementById('fileinput').files[0];
  reader = new FileReader(); 
  reader.readAsText(nEMAFile); // Read file into memory   
  // Handle progress, success, and errors 
  //reader.onprogress = updateProgress;
  reader.onload = loaded;
  reader.onerror = errorHandler;
  } 
  
function loaded(evt) 
  {
  // Obtain the read file data
  var fileString = evt.target.result;
  // Handle file dump
  $( "#nEMAText" ).html( fileString );  
  processHTML(fileString);
  } 

function errorHandler(evt) 
    { 
    if(evt.target.error.name == "NotReadableError") 
      {
      // The file could not be read
      $( "#nEMAText" ).html( "File read error" ); 
      } 
    }
  
function checkHTTP()
  {  
  if (interval > 0) {clearInterval(interval)}; //stop both http and nema.txt
  $( "#nEMAText" ).html( '' );
  if ( document.getElementById("checkBoxHTTP").checked == true )
    {
    document.getElementById('uploadFile_div').innerHTML = document.getElementById('uploadFile_div').innerHTML; //reset / clear filereader 
    interval = setInterval( getHTML , readRate ); //start http
    } 
  }  
        
  </script> 

</body>
</html>
