<!DOCTYPE html>  
<html> 
<head>
<meta name="description" content="NEMA">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-3.1.0.js">
    </script>
    <script src="https://www.emogic.com/jqueryrotate/jQueryRotate.js">
    </script>
  
  <title>BridgeCommand JS Instrumentation</title>
</head>
<body>

<img id='rudder' src="http://www.stickpng.com/assets/images/58f8bcf70ed2bdaf7c128307.png" width='100'>

<img id='compass' src="https://ceco.net/autocad-download/free-drawings-dwg-dxf/autocad-drawing-north-arrow-14-compass-rose-symbols-signs-signals-arrows-dwg-dxf-81.png" width='200'>
  
 <!-- http://jqueryrotate.com/ 
https://images-na.ssl-images-amazon.com/images/I/61lhqZxJ36L._UX522_.jpg
-->
<p>
HTTP: <input type="checkbox" id="checkBoxHTTP" onchange="checkHTTP()">    
<p>
OR
<p>
   
  <div id="uploadFile_div">
   <input id='fileinput' type="file" onchange='interval = setInterval( fileSelected , 50);' />
   </div>
  
<p>

  <div id='nEMAText'></div>
  
<script>
     
var filet = 'file:///home/adsiltia/Desktop/bridgecommand/bc-master/NEMA.txt';
var interval;
  
function getHTML() 
    {
    $.get( "http://127.0.0.1:8080", processHTML )
      .fail(function() { $( "#nEMAText" ).html( 'ajax error' ); }); 
    } 
  
function processHTML(data)
    {
    $( "#nEMAText" ).html('');
 
    var DataArray = data.split("\n"); //turn lines into array 
    var LineArray;
    //convert wanted lines to JSON
    
    // $--RMC
    var RMC = {};
    var RSA = {}; 
      
    for (var i = 0, len = DataArray.length; i < len; i++) 
        {
        $( "#nEMAText" ).append( DataArray[i]  + '</br>');
        LineArray = DataArray[i].split(","); //turn DataArray[i] (a string) into an array        
        //LineArray = DataArray[i].split(","); //turn line data into an array  
        //$( "#nEMAText" ).append( LineArray[1] + '</br>');
        //$( "#nEMAText" ).append( LineArray[1] + '</br>');
        if ( LineArray[0] == '$GPRMC' )
          {
          RMC['UTC'] = LineArray[1];   
          RMC['Status'] = LineArray[2];
          RMC['Track'] = LineArray[8];
          $( "#nEMAText" ).append( RMC['Track']  + '</br>');
          var ang = -1 * RMC['Track'];  
          //$("#compass").rotate({ angle: $("#compass").getRotateAngle() , animateTo:ang });    
          $("#compass").rotate({ angle:ang  }); 
          }
        if ( LineArray[0] == '$IIRSA' ) 
          {
          RSA['Starboard'] = LineArray[1];  
          //RMC['Status'] = LineArray[2]; 
          //RMC['Magnetic Variation'] = LineArray[10];
          $( "#nEMAText" ).append( RSA['Starboard']  + '</br>');
          var ang = - 1 * RSA['Starboard'];  
          //$("#rudder").rotate({ angle: $("#rudder").getRotateAngle() , animateTo:ang }); 
          $("#rudder").rotate({ angle: ang }); 
          } 
          
        }       
    }
  
function fileSelected() 
    {
    document.getElementById("checkBoxHTTP").checked = false;
    var reader;
    nEMAFile = document.getElementById('fileinput').files[0];
    reader = new FileReader(); 

    // Read file into memory
    reader.readAsText(nEMAFile);    
      
   // Handle progress, success, and errors 
   reader.onprogress = updateProgress;
   reader.onload = loaded;
   reader.onerror = errorHandler;
       
   //setTimeout( fileSelected , 250);
   } 
    
function updateProgress(evt) {
  if (evt.lengthComputable) {
    // evt.loaded and evt.total are ProgressEvent properties
    var loaded = (evt.loaded / evt.total);
    if (loaded < 1) {
      // Increase the prog bar length
      // style.width = (loaded * 200) + "px";
    }
  }
}

function loaded(evt) {
  // Obtain the read file data
  var fileString = evt.target.result;
  // Handle file dump
   $( "#nEMAText" ).html( fileString );  
  processHTML(fileString);
  //alert(fileString);
} 

function errorHandler(evt) {
  if(evt.target.error.name == "NotReadableError") {
    // The file could not be read
  }
}
  
function checkHTTP()
  {  
  //stop both http and nema.txt
  clearInterval(interval);
  $( "#nEMAText" ).html( '' );
    
  if ( document.getElementById("checkBoxHTTP").checked == true )
    {//start http
    document.getElementById('uploadFile_div').innerHTML = document.getElementById('uploadFile_div').innerHTML; 
    interval = setInterval( getHTML , 50); 
    } 

  }  
        
  </script> 
  d
  
</body>
</html>
