<!DOCTYPE html>  
<html> 
<head>
<meta name="description" content="NEMA">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-3.1.0.js">
    </script>
    <script src="https://www.emogic.com/jqueryrotate/jQueryRotate.js">
    </script>  
  <title>BridgeCommand JS Instrumentation</title>
</head>
<body>
  
<style>
.container 
  {
  position: relative;
  }
.over 
  {
  position: absolute;
  top: 0px;
  left: 0px;
  }    
 </style>
  
   <table>
    <tr>
      <td>
       HTTP: <input type="checkbox" id="checkBoxHTTP" onchange="checkHTTP()">  
        </td>
       <td>
       or  
        </td>
       <td>
       <div id="uploadFile_div">
   <input id='fileinput' type="file" onchange='interval = setInterval( fileSelected , 50);' />
   </div>
        </td>
      </tr>  
  </table>
  
  <table>     
  <tr>
    <td width='33%' class='container'>
      <img src="https://www.emogic.com/bc/rpm2.png" width='95%'>
      <img class="over" id='portRPM' src="https://www.emogic.com/bc/needle.png" width='95%'>
    </td>
    <td width='33%'><img id='compass' src="https://www.emogic.com/bc/compass.png" width='95%'></td>
    <td width='33%' class='container'>
      <img src="https://www.emogic.com/bc/rpm2.png" width='95%'><img class="over" id='starboardRPM' src="https://www.emogic.com/bc/needle.png" width='95%'>   
    </td>
    </tr>  
    
  <tr>
   <td width='33%'></td>
   <td width='33%' class='container'>
     <img src="https://www.emogic.com/bc/rudder.png" width='95%'>
     <img id='rudder'src="https://www.emogic.com/bc/rudderneedle.png" width='95%' class="over">
    </td>
   <td width='33%'></td>
 </tr>
  </table>
  
  <table>

  </table>
  
<div id='nEMAText'></div>
  
<script>
var interval;
  
function getHTML() 
    {
    $.get( "http://127.0.0.1:8080", processHTML )
      .fail(function() { $( "#nEMAText" ).html( 'ajax error' ); }); 
    } 
  
function processHTML(data)
    {
    $( "#nEMAText" ).html('');
 
    var DataArray = data.split("\n"); //turn lines into array 
    var LineArray;
    //convert wanted lines to JSON
    
    // $--RMC
    var RMC = {};
    var RSA = {}; 
    var RPM = {}; 
      
    for (var i = 0, len = DataArray.length; i < len; i++) 
        {
        $( "#nEMAText" ).append( DataArray[i]  + '</br>');
        LineArray = DataArray[i].split(","); //turn DataArray[i] (a string) into an array        

       if ( LineArray[0] == '$GPRMC' )
          {
          RMC['UTC'] = LineArray[1];   
          RMC['Status'] = LineArray[2];
          RMC['Track'] = LineArray[8];
          var ang = -1 * RMC['Track'];  
          $("#compass").rotate({ angle:ang  }); 
          }

        if ( LineArray[0] == '$IIRSA' )  
          {
          RSA['Starboard'] = LineArray[1];  
          var ang = - 2 * RSA['Starboard'];  
          $("#rudder").rotate({ angle: ang }); 
          } 

        if ( LineArray[0] == '$IIRPM' ) 
          {
          RPM['Number'] = LineArray[2]; 
          RPM['RMP'] = Math.abs( LineArray[3] ); //no neg RPM
          if ( RPM['Number'] == 1 ) 
            {
            var ang = .9 * RPM['RMP'];  
            $("#portRPM").rotate({ angle: ang }); 
            }
          if ( RPM['Number'] == 2 ) 
            {
            var ang = .9 * RPM['RMP'];  
            $("#starboardRPM").rotate({ angle: ang }); 
            }
          $( "#nEMAText" ).append( RPM['Number'] + ' , ' + RPM['RMP']  + '</br>');
          } 
          
        }       
    }
  
function fileSelected() 
    {
    document.getElementById("checkBoxHTTP").checked = false;
    var reader;
    nEMAFile = document.getElementById('fileinput').files[0];
    reader = new FileReader(); 

    // Read file into memory
    reader.readAsText(nEMAFile);    
      
   // Handle progress, success, and errors 
   reader.onprogress = updateProgress;
   reader.onload = loaded;
   reader.onerror = errorHandler;
   } 
    
function updateProgress(evt) {
  if (evt.lengthComputable) {
    // evt.loaded and evt.total are ProgressEvent properties
    var loaded = (evt.loaded / evt.total);
    if (loaded < 1) {
      // Increase the prog bar length
      // style.width = (loaded * 200) + "px";
    }
  }
}

function loaded(evt) 
  {
  // Obtain the read file data
  var fileString = evt.target.result;
  // Handle file dump
  $( "#nEMAText" ).html( fileString );  
  processHTML(fileString);
  } 

function errorHandler(evt) 
    {
    if(evt.target.error.name == "NotReadableError") 
      {
      // The file could not be read
      $( "#nEMAText" ).html( "File read error" ); 
      }
    }
  
function checkHTTP()
  {  
  //stop both http and nema.txt
  clearInterval(interval);
  $( "#nEMAText" ).html( '' );
    
  if ( document.getElementById("checkBoxHTTP").checked == true )
    {//start http
    document.getElementById('uploadFile_div').innerHTML = document.getElementById('uploadFile_div').innerHTML; 
    interval = setInterval( getHTML , 50); 
    } 
  }  
        
  </script> 
  
</body>
</html>
